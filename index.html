<!DOCTYPE html>
<html>

<head>
    <title>Search On AMLL歌词数据库</title>
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/5.1.1/css/bootstrap.min.css">
    <script src="https://cdn.staticfile.org/popper.js/2.9.3/umd/popper.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/5.1.1/js/bootstrap.min.js"></script>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.0/dist/APlayer.min.css">
    <script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.0/dist/APlayer.min.js"></script>
    <link rel="icon"
        href="https://github.com/Steve-xmh/applemusic-like-lyrics/raw/main/packages/bncm/src/assets/amll-icon.svg"
        type="image/png">
    <script>
        //预获取AMLL歌词数据库信息
        //http://music.163.com/api/song/detail/?id=1296345669&ids=[1296345669]
        console.log('initiate vars');
        //
        var amll_data = [];
        var ncm_data_name = [];
        var current_name;
        var current_singer;
        var current_pic;
        //
        console.log('fetch from github');
        //
        fetch('https://api.github.com/repos/Steve-xmh/amll-ttml-db/contents/lyrics')
            .then(response => response.json())
            .then(data => {
                // data 是包含文件和子文件夹信息的数组
                // 遍历数组并获取每个对象的 name 字段
                data.forEach(file => {
                    console.log('Fetch amll lyrics db successfully');
                    const ttml_id = file.name.replace(/\.ttml$/, '');
                    amll_data.push(ttml_id);
                });
                console.log(amll_data);
            });
        //
        console.log('push amll_data successfully');
        //
        function fetchNcmData() {
            //
            console.log('write ttml_id data to html');
            //
            //取歌曲名
            //向网页写数据
            // 获取表格的 HTML 元素
            const table = document.getElementById('amll_data_list');
            const tbody = table.querySelector('tbody');
            // 清空内容
            console.log('clean tbody data');
            tbody.innerHTML = '';
            console.log('clean ncm_data_name');
            ncm_data_name = [];
            // 使用 for 循环遍历数组
            for (let i = 0; i < amll_data.length; i++) {
                // 创建表格行元素
                const row = document.createElement('tr');
                // 创建表格单元格元素
                const no = document.createElement('td');
                const id = document.createElement('td');
                const sname = document.createElement('td');
                const cbutton = document.createElement('td');
                const csinger = document.createElement('td');
                // 设置单元格的文本内容
                no.textContent = i + 1;
                id.textContent = amll_data[i];
                // sname.textContent = 'loading';
                sname.innerHTML = '<div class="spinner-grow spinner-grow-sm text-primary"></div>';
                sname.setAttribute('ncmname', i);
                cbutton.innerHTML = "<button type=\"button\" class=\"btn btn-outline-primary\" data-bs-toggle=\"modal\" data-bs-target=\"#details\" onclick=\"fetchDetails(" + amll_data[i] + ")\">详情</button>";
                cbutton.setAttribute('ncmid', amll_data[i])
                csinger.innerHTML = '<div class="spinner-grow spinner-grow-sm text-primary"></div>';
                csinger.setAttribute('ncmsname', i)
                // 将单元格添加到行中
                row.appendChild(no);
                row.appendChild(id);
                row.appendChild(sname);
                row.appendChild(csinger);
                row.appendChild(cbutton);
                // 将行添加到表格的 tbody 中
                tbody.appendChild(row);
            }
            //
            console.log('write ncm_name data to html');
            //
            for (let i = 0; i < amll_data.length; i++) {
                // console.log(amll_data[i] + 'https://autumnfish.cn/song/detail?ids=' + amll_data[i]);
                //1296345669 1901371647 https://autumnfish.cn/song/detail?ids=1901371647
                fetch('https://autumnfish.cn/song/detail?ids=' + amll_data[i])
                    .then(response => response.json())
                    .then(data => {
                        // 输出name字段
                        var name = data.songs[0].name;
                        var singername = data.songs[0].ar[0].name;
                        // console.log('fetch:' + amll_data[i] + ' ' + name);
                        ncm_data_name.push(name);
                        console.log('Fetch ncm info db successfully');
                        var tdElement = document.querySelector('td[ncmname=\'' + i + '\']');
                        // 检查是否找到了元素
                        if (tdElement) {
                            // 写入数据
                            tdElement.innerText = name;
                        } else {
                            console.log('Cannot get attribute <td> with ncmname');
                        }
                        var tdElement = document.querySelector('td[ncmsname=\'' + i + '\']');
                        // 检查是否找到了元素
                        if (tdElement) {
                            // 写入数据
                            tdElement.innerText = singername;
                        } else {
                            console.log('Cannot get attribute <td> with ncmsname');
                        }
                    });
            }
            //ncm_data_name
            console.log(ncm_data_name);
            console.log('push ncm_data_name successfully');
            console.log('func ncmdata for successfully');
        }

        function fetchNcmDataByID() {
            const ncmIdValue = document.getElementById('ncm_id').value; //取值
            for (let i = 0; i < amll_data.length; i++) {
                if (ncmIdValue == amll_data[i]) {
                    console.log('write ttml_id data to html');
                    //取歌曲名
                    //向网页写数据
                    // 获取表格的 HTML 元素
                    const table = document.getElementById('amll_data_list');
                    const tbody = table.querySelector('tbody');
                    // 清空内容
                    console.log('clean tbody data');
                    tbody.innerHTML = '';
                    console.log('clean ncm_data_name');
                    ncm_data_name = [];
                    // 创建表格行元素
                    const row = document.createElement('tr');
                    // 创建表格单元格元素
                    const no = document.createElement('td');
                    const id = document.createElement('td');
                    const sname = document.createElement('td');
                    const cbutton = document.createElement('td');
                    const csinger = document.createElement('td');
                    // 设置单元格的文本内容
                    no.textContent = i + 1;
                    id.textContent = amll_data[i];
                    cbutton.innerHTML = "<button type=\"button\" class=\"btn btn-outline-primary\" data-bs-toggle=\"modal\" data-bs-target=\"#details\" onclick=\"fetchDetails(" + amll_data[i] + ")\">详情</button>";
                    cbutton.setAttribute('ncmid', amll_data[i])
                    // sname.textContent = 'loading';
                    sname.innerHTML = '<div class="spinner-grow spinner-grow-sm text-primary"></div>';
                    sname.setAttribute('ncmname', i);
                    csinger.innerHTML = '<div class="spinner-grow spinner-grow-sm text-primary"></div>';
                    csinger.setAttribute('ncmsname', i)
                    // 将单元格添加到行中
                    row.appendChild(no);
                    row.appendChild(id);
                    row.appendChild(sname);
                    row.appendChild(csinger);
                    row.appendChild(cbutton);
                    // 将行添加到表格的 tbody 中
                    tbody.appendChild(row);
                    fetch('https://autumnfish.cn/song/detail?ids=' + amll_data[i])
                        .then(response => response.json())
                        .then(data => {
                            // 输出name字段
                            var name = data.songs[0].name;
                            var singername = data.songs[0].ar[0].name;
                            // current_name = data.songs[0].name;
                            // current_singer = data.songs[0].ar.name;
                            // current_pic = data.songs[0].al.picUrl;
                            // console.log('fetch:' + amll_data[i] + ' ' + name);
                            ncm_data_name.push(name);
                            console.log('Fetch ncm info db successfully');
                            var tdElement = document.querySelector('td[ncmname=\'' + i + '\']');
                            // 检查是否找到了元素
                            if (tdElement) {
                                // 写入数据
                                tdElement.innerText = name;
                            } else {
                                console.log('Cannot get attribute <td> with ncmname');
                            }
                            var tdElement = document.querySelector('td[ncmsname=\'' + i + '\']');
                            // 检查是否找到了元素
                            if (tdElement) {
                                // 写入数据
                                tdElement.innerText = singername;
                            } else {
                                console.log('Cannot get attribute <td> with ncmsname');
                            }
                        });
                    //
                    console.log('write ncm_name data to html');
                    break;
                }
            }
        }

        function fetchNcmDataByName() {
            // 清空内容
            const table = document.getElementById('amll_data_list');
            const tbody = table.querySelector('tbody');
            console.log('clean tbody data');
            tbody.innerHTML = '';
            console.log('clean ncm_data_name');
            ncm_data_name = [];
            var amll_id;
            var ncm_names = [];
            var ncm_ids;
            var ncm_ii;
            const ncmNameValue = document.getElementById('ncm_name').value; //取值
            fetch('https://api.github.com/repos/Steve-xmh/amll-ttml-db/contents/lyrics')
                .then(response => response.json())
                .then(data => {
                    // data 是包含文件和子文件夹信息的数组
                    // 遍历数组并获取每个对象的 name 字段
                    let ii = 0;
                    data.forEach(file => {
                        console.log('Fetch amll lyrics db successfully');
                        const ttml_id = file.name.replace(/\.ttml$/, '');
                        // amll_data.push(ttml_id);
                        // amll_data.push(ttml_id);
                        fetch('https://autumnfish.cn/song/detail?ids=' + ttml_id)
                            .then(response => response.json())
                            .then(data => {
                                // 输出name字段
                                var ssname = data.songs[0].name;
                                var singername = data.songs[0].ar[0].name;
                                // current_name = data.songs[0].name;
                                // current_singer = data.songs[0].ar.name;
                                // current_pic = data.songs[0].al.picUrl;
                                // console.log('fetch:' + amll_data[i] + ' ' + name);
                                // ncm_names.push(name);
                                console.log('Fetch ncm info db successfully');
                                if (ncmNameValue == ssname) {
                                    ncm_ids = ttml_id;
                                    console.log('write ttml_id data to html');
                                    //取歌曲名
                                    //向网页写数据
                                    // 获取表格的 HTML 元素
                                    const table = document.getElementById('amll_data_list');
                                    const tbody = table.querySelector('tbody');
                                    // 清空内容
                                    // 创建表格行元素
                                    const row = document.createElement('tr');
                                    // 创建表格单元格元素
                                    const no = document.createElement('td');
                                    const id = document.createElement('td');
                                    const sname = document.createElement('td');
                                    const cbutton = document.createElement('td');
                                    const csinger = document.createElement('td');
                                    // 设置单元格的文本内容
                                    no.textContent = ii + 1;
                                    id.textContent = ncm_ids;
                                    cbutton.innerHTML = "<button type=\"button\" class=\"btn btn-outline-primary\" data-bs-toggle=\"modal\" data-bs-target=\"#details\" onclick=\"fetchDetails(" + ncm_ids + ")\">详情</button>";
                                    cbutton.setAttribute('ncmid', ncm_ids)
                                    // sname.textContent = 'loading';
                                    sname.innerHTML = ssname;
                                    // sname.setAttribute('ncmname', ncm_ii);
                                    csinger.innerHTML = singername;
                                    // csinger.setAttribute('ncmsname', ncm_ii)
                                    // 将单元格添加到行中
                                    row.appendChild(no);
                                    row.appendChild(id);
                                    row.appendChild(sname);
                                    row.appendChild(csinger);
                                    row.appendChild(cbutton);
                                    // 将行添加到表格的 tbody 中
                                    tbody.appendChild(row);
                                    //
                                    console.log('write ncm_name data to html');
                                    // ii++;
                                }
                                ii++;
                            });
                        // ii++;
                    });
                });
        }

        let ap;//父级作用域
        function fetchDetails(ttml_id) {
            var music_id = ttml_id;
            var music_src;
            const details_title = document.getElementById('m-title');
            const details_body = document.getElementById('m-body');
            const details_footer = document.getElementById('m-footer');
            const details_pic = document.getElementById('m-pic');
            const details_singer = document.getElementById('m-singer');
            const details_name = document.getElementById('m-name');
            const details_audio = document.getElementById('m-audio');
            const details_links = document.getElementById('m-links');
            fetch('https://autumnfish.cn/song/detail?ids=' + music_id)
                .then(response => response.json())
                .then(data => {
                    // 输出name字段
                    current_name = data.songs[0].name;
                    current_singer = data.songs[0].ar[0].name;
                    current_pic = data.songs[0].al.picUrl;
                    // console.log('fetch:' + amll_data[i] + ' ' + name);
                    details_pic.innerHTML = "<img src=\" " + current_pic + "\" width=\"100vh\" />";
                    details_singer.innerHTML = current_singer;
                    details_name.innerHTML = current_name;
                });
            // details_title.innerHTML = music_id;
            // details_body.innerHTML = music_id;
            // details_footer.innerHTML = music_id;
            fetch('https://autumnfish.cn/song/url/v1?id=' + music_id + '&level=standard')
                .then(response => response.json())
                .then(data => {
                    // data 是包含文件和子文件夹信息的数组
                    // 遍历数组并获取每个对象的 name 字段
                    console.log('Fetch audio from ncm successfully');
                    music_src = data.data[0].url;
                    //details_audio.innerHTML = '<audio src=\'' + music_src + '\' controls />'; APlayer代替
                    details_links.innerHTML = '<button type=\"button\" class=\"btn btn-outline-success btn-block\" onclick=\"window.location.href=\'https://music.163.com/#/song?id=' + music_id + '\'\">网易云歌曲页面</button>';
                    const ap = new APlayer({
                        container: document.getElementById('aplayer'),
                        audio: [{
                            name: current_name,
                            artist: current_singer,
                            url: music_src,
                            cover: current_pic
                        }]
                    });
                });
        }

        function shutAplayer() {
            // ap.pause(); aplayer提供的pause无效
            // ap.destroy(); aplayer提供的destroy无效
            ap = null;
            console.log("destroy aplayer");
            //关闭模态框后销毁aplayer 将变量重新赋值为null，以便释放引用
        }
    </script>
</head>

<body>
    <div class="container p-5 my-5 border">
        <div class="row">
            <div class="col"></div>
            <div class="col-6">
                <div class="container">
                    <img src="https://github.com/Steve-xmh/applemusic-like-lyrics/raw/main/packages/bncm/src/assets/amll-icon.svg"
                        class="mx-auto d-block" alt="Centered Image">
                </div>
                <!-- <img src="https://github.com/Steve-xmh/amll-ttml-tool/blob/main/public/logo.svg" width="100vh"/> -->
                <h2 style="text-align: center;">Search On AMLL歌词数据库</h2>
                <h4 style="text-align: center;">专为<a href="https://github.com/Steve-xmh/amll-ttml-db"
                        target="_blank">AMLL TTML DB</a>设计</h4>
            </div>
            <div class="col"></div>
        </div>
    </div>
    <div class="container p-5 my-5 border">
        <div class="row">
            <div class="col"></div>
            <div class="col-6">
                <form>
                    <div class="mb-3 mt-3">
                        <label for="ncm_id" class="form-label">歌曲ID</label>
                        <input type="ncm_id" class="form-control" id="ncm_id" placeholder="网易云音乐歌曲ID" name="ncm_id">
                    </div>
                    <div class="mb-3">
                        <label for="ncm_name" class="form-label">歌曲名称</label>
                        <input type="ncm_name" class="form-control" id="ncm_name" placeholder="歌名" name="ncm_name">
                    </div>
                    <!-- <button type="submit" class="btn btn-primary" onclick="fetchNcmData()">Submit</button> -->
                </form>
                <div class="row">
                    <div class="col-4 d-grid"><button class="btn btn-primary btn-block"
                            onclick="fetchNcmData()">查询所有歌词</button></div>
                    <div class="col-4 d-grid"><button class="btn btn-outline-primary btn-block"
                            onclick="fetchNcmDataByID()">按音乐ID查询</button></div>
                    <div class="col-4 d-grid"><button class="btn btn-outline-success btn-block"
                            onclick="fetchNcmDataByName()">按歌名查询</button></div>
                </div>
            </div>
            <div class="col"></div>
        </div>
        <!---->
        <div class="row"></div>
        <hr>
        <div class="row"></div>
        <div class="row">
            <div class="col"></div>
            <div class="col-10">
                <table class="table table-hover" id="amll_data_list">
                    <thead>
                        <tr>
                            <th>序号</th>
                            <th>id</th>
                            <th>歌名</th>
                            <th>歌手</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <!--写查询数据 Begin-->
                    <tbody>
                    </tbody>
                    <!--写查询数据 End-->
                </table>
            </div>
            <div class="col"></div>
        </div>
        <div class="row">
            <hr>
            <small style="font-weight: bold;">1.2 - 231217</small>
            <small>
                Powered by Bootstrap, Github, APlayer<br>
                For <span class="badge bg-danger">AMLL</span> and <span class="badge bg-success">AMLL TTML
                    Tool</span>
            </small>
        </div>
        <!-- 模态框 -->
        <div class="modal fade" id="details">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <!-- 模态框头部 -->
                    <div class="modal-header">
                        <h4 class="modal-title" id="m-title">歌曲详情</h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                            onclick="shutAplayer()"></button>
                    </div>
                    <!-- 模态框内容 -->
                    <div class="modal-body">
                        <div id="m-body"></div>
                        <div class="container">
                            <div class="row">
                                <div class="col-3" id="m-pic">
                                </div>
                                <div class="col">
                                    <div class="row" id="m-name" style="font-weight: bold;">歌曲名称</div>
                                    <div class="row" id="m-singer">歌手</div>
                                    <div class="row">
                                        <hr>
                                    </div>
                                    <div class="row">
                                        <!-- <div id="aplayer"></div>暂时禁用原生audio -->
                                        <div class="col-6" id="m-audio"></div>
                                        <div class="col"></div>
                                        <div class="col"></div>
                                    </div>
                                    <div class="row">
                                        <div class="col-10">
                                            <div id="aplayer"></div>
                                        </div>
                                        <div class="col"></div>
                                        <div class="col"></div>
                                    </div>
                                    <div class="row"></div>
                                    <div class="row">
                                        <div class="col-10 d-grid" id="m-links">
                                            <div class="spinner-border text-success"></div>
                                        </div>
                                        <div class="col"></div>
                                        <div class="col"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 模态框底部 -->
                    <div class="modal-footer">
                        <div id="m-footer" style="text-align: left;"></div>
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal"
                            onclick="shutAplayer()">关闭</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>